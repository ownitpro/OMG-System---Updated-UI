// OMG Systems - Aurora PostgreSQL Schema
// Client-First Backend Implementation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════════
// CORE MODELS (Used by both Client & Admin)
// ═══════════════════════════════════════════════════════════════

enum UserRole {
  ADMIN
  CLIENT
  OWNER
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String?
  password          String?
  role              UserRole  @default(CLIENT)
  phone             String?
  company           String?
  position          String?
  avatar            String?
  emailVerified     DateTime?
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  stripeCustomerId  String?   @unique
  resetToken        String?
  resetTokenExpiry  DateTime?

  // Relationships
  organizationId    String?
  organization      Organization? @relation(fields: [organizationId], references: [id])

  // Client-side relations
  subscriptions     Subscription[]
  invoices          Invoice[]
  paymentMethods    PaymentMethod[]
  strategySessions  StrategySession[]
  timeEntries       TimeEntry[]
  supportTickets    SupportTicket[]
  adCampaigns       AdCampaign[]
  contentProjects   ContentProject[]
  automations       Automation[]
  brandAssets       BrandAsset[]
  designRequests    DesignRequest[]
  customProjects    CustomProject[]

  // Admin-side relations (created by)
  ordersCreated     Order[]           @relation("OrderCreator")
  couponsCreated    Coupon[]          @relation("CouponCreator")

  // Security
  activeSessions    ActiveSession[]
  loginHistory      LoginHistory[]

  // NextAuth
  accounts          Account[]
  sessions          Session[]

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  email       String?
  phone       String?
  website     String?
  logo        String?

  // Relations
  users       User[]
  orders      Order[]
  coupons     Coupon[]
  analytics   AnalyticsEvent[]
  leads       Lead[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@map("organizations")
}

// ═══════════════════════════════════════════════════════════════
// CLIENT PORTAL MODELS
// ═══════════════════════════════════════════════════════════════

// --- Billing ---

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  PAUSED
}

model Subscription {
  id                   String             @id @default(cuid())
  stripeSubscriptionId String?            @unique
  plan                 String
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)

  userId               String
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

enum InvoiceStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
}

model Invoice {
  id              String        @id @default(cuid())
  stripeInvoiceId String?       @unique
  invoiceNumber   String        @unique
  amount          Float
  currency        String        @default("CAD")
  status          InvoiceStatus @default(PENDING)
  dueDate         DateTime
  paidAt          DateTime?
  description     String?

  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())

  @@index([userId])
  @@index([status])
  @@map("invoices")
}

model PaymentMethod {
  id                    String   @id @default(cuid())
  stripePaymentMethodId String?  @unique
  type                  String   // card, bank_account
  last4                 String
  brand                 String?  // visa, mastercard
  expiryMonth           Int?
  expiryYear            Int?
  isDefault             Boolean  @default(false)

  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime @default(now())

  @@index([userId])
  @@map("payment_methods")
}

// --- Strategy Sessions ---

enum SessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

model StrategySession {
  id              String        @id @default(cuid())
  title           String
  description     String?
  scheduledAt     DateTime
  durationMinutes Int           @default(60)
  status          SessionStatus @default(SCHEDULED)
  meetingLink     String?
  notes           String?
  recordingUrl    String?

  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([scheduledAt])
  @@index([status])
  @@map("strategy_sessions")
}

// --- Timeguard AI ---

model TimeEntry {
  id          String    @id @default(cuid())
  project     String
  description String?
  startTime   DateTime
  endTime     DateTime?
  duration    Int?      // Minutes (calculated)
  billable    Boolean   @default(true)
  tags        String[]

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([startTime])
  @@index([project])
  @@map("time_entries")
}

// --- Support ---

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_RESPONSE
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SupportTicket {
  id          String         @id @default(cuid())
  subject     String
  description String
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    String?

  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages    TicketMessage[]

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([userId])
  @@index([status])
  @@map("support_tickets")
}

model TicketMessage {
  id        String   @id @default(cuid())
  content   String
  isStaff   Boolean  @default(false)
  authorId  String

  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@map("ticket_messages")
}

// --- Security ---

model ActiveSession {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  device       String?
  browser      String?
  os           String?
  ip           String?
  location     String?
  lastActive   DateTime @default(now())

  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())

  @@index([userId])
  @@map("active_sessions")
}

model LoginHistory {
  id        String   @id @default(cuid())
  ip        String?
  device    String?
  browser   String?
  location  String?
  success   Boolean  @default(true)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("login_history")
}

// ═══════════════════════════════════════════════════════════════
// ADMIN PORTAL MODELS
// ═══════════════════════════════════════════════════════════════

// --- Orders ---

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  customerName  String
  customerEmail String
  product       String
  amount        Float
  currency      String      @default("CAD")
  status        OrderStatus @default(PENDING)
  notes         String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById   String
  createdBy     User        @relation("OrderCreator", fields: [createdById], references: [id])

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@map("orders")
}

// --- Coupons ---

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum CouponCategory {
  PROMO
  PARTNER
  LOYALTY
  SEASONAL
  REFERRAL
  OTHER
}

model Coupon {
  id             String          @id @default(cuid())
  code           String          @unique
  description    String?
  type           CouponType
  value          Float           // Percent off (0-100) or fixed cents

  // Limits
  maxUses        Int?            // Max total redemptions
  currentUses    Int             @default(0)
  minPurchase    Float?          // Minimum order amount (cents)
  maxDiscount    Float?          // Cap on discount amount (cents)

  // Scheduling
  startsAt       DateTime?       // When coupon becomes active
  expiresAt      DateTime?       // When coupon expires

  // Status & Category
  isActive       Boolean         @default(true)
  isPublic       Boolean         @default(false)  // Show on public /promotions page
  category       CouponCategory  @default(OTHER)

  // Targeting (JSON fields for flexibility)
  appliesTo      String?         // JSON - "all" or ["product1", "product2"]
  assignedTo     String?         // JSON - "all" or ["client1", "client2"]

  // Restrictions
  firstTimeOnly  Boolean         @default(false)

  // Stacking
  stackable      Boolean         @default(false)
  stackGroup     String?
  priority       Int             @default(0)

  // Tracking
  totalSavings   Float           @default(0)  // Total $ saved by customers
  note           String?         // Admin notes

  // Relations
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById    String
  createdBy      User            @relation("CouponCreator", fields: [createdById], references: [id])

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([organizationId])
  @@index([code])
  @@index([isActive])
  @@index([category])
  @@index([expiresAt])
  @@map("coupons")
}

// --- Analytics ---

enum EventType {
  PAGE_VIEW
  BUTTON_CLICK
  FORM_SUBMIT
  API_CALL
  ERROR
  PURCHASE
  SIGNUP
  LOGIN
  LOGOUT
}

model AnalyticsEvent {
  id             String    @id @default(cuid())
  eventType      EventType
  eventName      String
  page           String?
  userId         String?
  sessionId      String?
  metadata       Json?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt      DateTime  @default(now())

  @@index([organizationId])
  @@index([eventType])
  @@index([createdAt])
  @@index([userId])
  @@map("analytics_events")
}

// --- Audit Logs ---

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entity      String
  entityId    String?
  changes     Json?
  userId      String
  userEmail   String
  ip          String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ═══════════════════════════════════════════════════════════════
// CLIENT PORTAL FEATURE MODELS
// ═══════════════════════════════════════════════════════════════

model AdCampaign {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  description   String?
  platform      String   // "Google", "Facebook", "LinkedIn", etc.
  status        String   @default("DRAFT") // DRAFT, ACTIVE, PAUSED, COMPLETED

  budget        Float
  spent         Float    @default(0)
  currency      String   @default("CAD")

  startDate     DateTime
  endDate       DateTime?

  // Metrics
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  conversions   Int      @default(0)
  ctr           Float?   // Click-through rate
  cpc           Float?   // Cost per click

  targetAudience String?
  adCreativeUrl  String?
  landingPageUrl String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("ad_campaigns")
}

model ContentProject {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  title         String
  description   String?
  type          String   // "Blog", "Video", "Social", "Email", "Ebook", etc.
  status        String   @default("DRAFT") // DRAFT, IN_PROGRESS, REVIEW, PUBLISHED

  dueDate       DateTime?
  publishedAt   DateTime?

  assignedTo    String?  // Team member or external writer
  wordCount     Int?
  targetKeywords String?  // JSON array as string

  draftUrl      String?
  finalUrl      String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@map("content_projects")
}

model Automation {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  description   String?
  type          String   // "Email", "Workflow", "Notification", "Data Sync", etc.
  status        String   @default("INACTIVE") // INACTIVE, ACTIVE, PAUSED, ERROR

  trigger       String   // JSON config: what starts the automation
  actions       String   // JSON config: what the automation does

  totalRuns     Int      @default(0)
  successfulRuns Int     @default(0)
  failedRuns    Int      @default(0)
  lastRunAt     DateTime?
  lastRunStatus String?  // "SUCCESS", "FAILED", "PARTIAL"

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("automations")
}

model BrandAsset {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name          String
  description   String?
  type          String   // "Logo", "Color Palette", "Typography", "Template", "Guide", etc.
  category      String?  // "Primary", "Secondary", "Social Media", etc.

  fileUrl       String?
  thumbnailUrl  String?
  fileSize      Int?     // in bytes
  fileFormat    String?  // "PNG", "SVG", "PDF", "AI", etc.

  dimensions    String?  // "1920x1080" or JSON for multiple sizes
  colorCodes    String?  // JSON array of hex codes

  version       String   @default("1.0")
  tags          String?  // JSON array

  downloadCount Int      @default(0)
  lastDownloadAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@map("brand_assets")
}

enum DesignRequestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model DesignRequest {
  id             String               @id @default(cuid())
  userId         String
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  projectName    String
  designType     String
  description    String               @db.Text
  deadline       DateTime?
  budget         String?
  existingAssets String?              @db.Text
  status         DesignRequestStatus  @default(PENDING)

  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([userId])
  @@index([status])
  @@map("design_requests")
}

model CustomProject {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  description     String?
  type            String   // "Integration", "Custom Development", "Consulting", etc.
  status          String   @default("PLANNING") // PLANNING, IN_PROGRESS, REVIEW, COMPLETED, ON_HOLD

  startDate       DateTime?
  targetEndDate   DateTime?
  completedAt     DateTime?

  progress        Int      @default(0) // 0-100

  milestones      String?  // JSON array of milestone objects
  deliverables    String?  // JSON array of deliverable objects
  nextDeliverable String?

  assignedTeam    String?  // JSON array of team members
  estimatedHours  Int?
  actualHours     Int?

  budget          Float?
  spent           Float?
  currency        String   @default("CAD")

  repositoryUrl   String?
  documentationUrl String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("custom_projects")
}

// ═══════════════════════════════════════════════════════════════
// LEAD CAPTURE MODELS
// ═══════════════════════════════════════════════════════════════

enum LeadSource {
  APPS
  SOLUTIONS
  MARKETING
  INDUSTRIES
  AI_AGENTS
  CONTENT_ENGINE
  CUSTOM_APPS
  SMART_AUTOMATIONS
  CONTACT
}

enum LeadStatus {
  NEW
  CONTACTED
  NURTURING
  QUALIFIED
  CONVERTED
  LOST
}

model Lead {
  id              String      @id @default(cuid())

  // Contact Information (Common to all forms)
  name            String
  email           String
  phone           String?
  company         String?

  // Lead Metadata
  source          LeadSource
  status          LeadStatus  @default(NEW)
  industry        String?     // Industry (for Industries form or general)
  message         String?     // Message/Challenge/Description
  tags            String?     // JSON array of tags

  // Apps Form Fields
  interestedApps  String?     // JSON array: ["crm", "leads", "securevault"]
  crmIndustry     String?     // Industry template selection

  // Solutions Form Fields
  solutionInterested String?  // "timeguard-ai", "automations", "strategy-session", "custom-solutions"
  teamSize        String?     // "1-5", "6-20", "21-50", "51-100", "100+"

  // Marketing Form Fields
  servicesInterested String?  // JSON array: ["ads", "branding", "content"]
  budget          String?     // "<$1k", "$1k-5k", "$5k-10k", "$10k+"
  goals           String?     // Marketing goals text

  // Industries Form Fields
  companySize     String?     // "1-5", "6-20", "21-50", "51-100", "100+"
  challenges      String?     // Biggest challenge text

  // AI Agents Form Fields
  agentType       String?     // "lead-capture", "customer-support", "scheduling", "data-entry", "email-automation", "custom"
  agentDescription String?    // What the agent should do
  preferredStartDate DateTime? // When they want to start

  // Content Engine Form Fields
  contentTypes    String?     // JSON array: ["blog-posts", "social-media", "email-campaigns", "video-scripts", "ad-copy", "whitepapers"]
  monthlyVolume   String?     // "1-10", "11-25", "26-50", "50+"
  contentChallenge String?    // Biggest content challenge text

  // Custom Apps Form Fields
  selectedModules String?     // JSON array: ["dashboard", "forms", "user-portal", "crm-integration", "database", "notifications", "scheduling", "workflows", "analytics", "ai-features"]
  coreObjectives  String?     // What problem are we solving? Technical goals
  additionalNotes String?     // Timeline constraints, budget ranges, integration endpoints

  // Contact Form Fields
  subject         String?     // Contact form subject
  timeline        String?     // Project timeline

  // Additional form data (JSON for future extensibility)
  formData        String?     // JSON object for any additional custom fields

  // Organization (if lead becomes a customer)
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([source])
  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([organizationId])
  @@map("leads")
}
